<html lang = "en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join</title>

    <!-- css page -->
    <link rel="stylesheet" href="styles.css">

    <!-- fonts used -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MuseoModerno:ital,wght@0,100..900;1,100..900&family=Overpass:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body>
    <h1>Join!</h1>

    <form id="dynamicForm">
        <!-- The container for dynamically generated questions will go here -->
        <label for="name">Name</label>
        <input type="text" name="name" id="name" required>


        <div id="questionsContainer"></div>

        <br>

        <input type="submit" value="Submit">
    </form>

    <div id="confirmationMessage" class="confirmation-message"></div>

    <div class="buttons">
        <a href="index.html" class="button">Back</a>
    </div>





    <script type="module">

        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js'
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js'
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyCZtBOyQgLvt0cHkaj1OZ3C07mdrZVfMoc",
        authDomain: "votingproject-98318.firebaseapp.com",
        databaseURL: "https://votingproject-98318-default-rtdb.firebaseio.com",
        projectId: "votingproject-98318",
        storageBucket: "votingproject-98318.appspot.com",
        messagingSenderId: "176078442562",
        appId: "1:176078442562:web:30d90f27d34d9bc5b95ddb",
        measurementId: "G-VEBCVDK86J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        var dataSize=0;

        const db = getDatabase();
        const optionsRef = ref(db, 'options/options');

        const amountRef = ref(db, 'amount/amount');
        var amount = 0;
        onValue(amountRef, (snapshot) =>{
            amount = snapshot.val();
            console.log(amount);
        });

        window.updateOptions = function(selectElement) {
            const selectedOptions = [];
            selectedOptions.push('');
            const allSelectElements = document.querySelectorAll('.select-question');

            allSelectElements.forEach(element => {
                selectedOptions.push(element.value);
                console.log(element.value);
            });

            allSelectElements.forEach(element => {
                const options = element.querySelectorAll('option');
                options.forEach(option => {
                    if (selectedOptions.includes(option.value)) {
                        if (element.value!=option.value){
                            option.disabled = true;
                        }
                    } else {
                        option.disabled = false;
                    }
                });
            });
        }

        onValue(optionsRef, (snapshot) => {
            const data = snapshot.val();
            dataSize = data.length;

            const questionsContainer = document.getElementById('questionsContainer');

            for (let i = 0; i<amount; i++){
                const question = document.createElement('select');
                question.id = "select" +i;
                question.name = "select"+i;
                question.setAttribute('class', 'select-question');
                const questionLabel = document.createElement('label');
                questionLabel.for = "select"+i;
                questionLabel.textContent = "Rank #" + (i+1);
                questionsContainer.appendChild(questionLabel);
                questionsContainer.appendChild(question);
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Select an option";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                question.appendChild(defaultOption);
                question.required = true;
                question.setAttribute('onchange', 'updateOptions(this)');
                for (let j = 0; j<dataSize; j++){
                    
                    const option = document.createElement('option');
                    option.value = data[j];
                    option.textContent = data[j];
                    option.id = "answer" + i + "-" + j;
                    option.name = "answer" + i;
                    const thisQuestion = document.getElementById('select' + i);
                    thisQuestion.appendChild(option);

                    // const label = document.createElement('label');
                    // label.textContent=data[j];
                    // label.for="answer" + i + "-"+ j;
                    // label.class="radio-label";

                    // const answer = document.createElement('input');
                    // answer.type = 'radio';
                    // answer.id = "answer" + i + "-"+ j;
                    // answer.name="answer" + i;
                    // answer.value = data[j];
                    // answer.required=true;

                    // questionsContainer.appendChild(label);
                    // label.appendChild(answer);
                }
            }
        })

        function getPoints(rank){
            console.log('amount:' + amount);
            console.log('rank:'+ rank);
            console.log(1+Number(amount)-rank);
            if (amount == dataSize) {
                return Number(amount)-rank;
            }
            else {
                return 1+Number(amount)-rank;
            }
        }


        const form = document.getElementById("dynamicForm");
        const confirmationMessage = document.getElementById('confirmationMessage');
        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            // Get form data
            const formData = new FormData(form);

            const person = formData.get('name');

            console.log(formData.get('select'+0));

            for (let i = 0; i<amount; i++){
                const choice = formData.get('select' + i);
                const points = getPoints(1+i);
                console.log('points:' +points);

                set(ref(db, "people/" +person + "/" + choice),{
                    points : points
                });
            }
            confirmationMessage.textContent = 'Form submitted successfully!';
            confirmationMessage.style.display = 'block';



        });




    </script>
</body>

</html>